

class ColorScan{constructor(e){this._imageId=e.imageId,this._canvasId=e.canvasId,this._hue_n=e.hue_n,this._lum_n=e.lum_n,this._type=e.type||"JPEG",this._canvas=null,this._image=null,this._context=null,this._imageData=null,this._data=null,this._capacity=0,this._display=null,this._hue_a=null,this._lum_a=null,this._hueCount_a=null,this._hueCountMax=0,this._lumCountMax_n=0,this.init()}init(){try{this._canvas=document.getElementById(this._canvasId),this._image=document.getElementById(this._imageId),this._canvas.width=this._image.width,this._canvas.height=this._image.height,this._display=this._canvas.style.display,this._context=this._canvas.getContext("2d"),this._context.drawImage(this._image,0,0),this._imageData=this._context.getImageData(0,0,this._image.width,this._image.height),this._data=this._imageData.data,this._capacity=this._data.length>>2,this._hue_a=new Array(this._hue_n);for(let e=0;e<this._hue_n;++e)this._hue_a[e]=[];this._lum_a=new Array(this._lum_n);for(let e=0;e<this._lum_n;++e)this._lum_a[e]=[]}catch(e){console.log(`[class ColorScan]init method error: ${e}`)}return this}scan(){try{console.time("scanM");const e=this._data.length;let t,s,_;for(let i=0;i<e;i+=4)t=this._data[i],s=this._data[i+1],_=this._data[i+2],this._hue_a[RGB_H(t,s,_)].push(i),this._lum_a[Math.floor(100*RGB_L(t,s,_))].push(i);return console.timeEnd("scanM"),this}catch(e){console.log(`[class ColorScan]init method error: ${e} -- at = ${at}`)}}getHue_a(){return this._hue_a}getHueCount_a(){if(null===this._hueCount_a){this._hueCount_a=new Array(this._hue_n);let e;for(let t=0;t<this._hue_n;++t)e=this._hue_a[t].length,this._hueCount_a[t]=e,e>this._hueCountMax&&(this._hueCountMax=e)}return this._hueCount_a}getHueCountMax(){return null===this._hueCount_a&&this.getHueCount_a(),this._hueCountMax}getHue_n(){return this._hue_n}getCapacity_n(){return this._capacity}getCanvasWidth(){return this._canvas.width}HSL_RGBA_a(e,t,s){const _=Math.floor(t*s)*this._canvas.width*4+4*Math.floor(e*s);return{r:this._data[_],g:this._data[_+1],b:this._data[_+2],a:this._data[_+3]}}HSL_HSLA_a(e,t,s){let _,i,a,l;return({r:_,g:i,b:a,a:l}=this.HSL_RGBA_a(e,t,s)),{h:RGB_H(_,i,a),s:RGB_S(_,i,a),l:RGB_L(_,i,a),a:l}}getSaturLumen_a(e){const t=new Int32Array(101),s=new Int32Array(101);let _=this._hue_a[e].length;for(let i=0;i<_;++i){const _=this._hue_a[e][i],a=this._data[_],l=this._data[_+1],n=this._data[_+2];t[Math.floor(100*RGB_S(a,l,n))]+=1,s[Math.floor(100*RGB_L(a,l,n))]+=1}return[t,s]}setDisplay(e){return e?(this._context.putImageData(this._imageData,0,0),this.display="inline"):this.display="none",this._canvas.style.display=this.display,this}setOpacity(e,t,s){let _;if(0===e){_=this._hue_a[t].length;for(let e=0;e<_;++e)this._data[this._hue_a[t][e]+3]=s}else{_=this._lum_a[t].length;for(let e=0;e<_;++e)this._data[this._lum_a[t][e]+3]=s}return this}}const SLIDER_TOP=0,SLIDER_EQ_HEIGHT=32,SLIDER_EQ_N=2;class ColorConsole{constructor(e){const t="hue"===e.mode?360:100;this._selectorId=e.selectorId,this._eqInputId=e.eqInputId,this._slidersId=e.slidersId,this._slideId=e.slideId,this._slider_n=e.slider_n,this._mode=e.mode,this._arcWidth=t/this._slider_n,this._slideWidth=Math.floor(.92*window.innerWidth/this._slider_n),this._consoleWidth=this._slider_n*this._slideWidth,this._gridColor=e.gridColor||DOM_getRootVar("--M3_CONSOLE_COLOR"),this._handle=e.handle,this._loose=!1,this._lastHit=0,this._paint=null,this._sliders_a=[],this._levels_a=[],DOM_setRootVar("--M3_CONSOLE_WIDTH",this._consoleWidth),this.init()}init(){this._paint=SVG(this._selectorId).size(this._consoleWidth,M3_SLIDE_RANGE+SLIDER_EQ_HEIGHT*SLIDER_EQ_N).attr("id",this._slidersId).addClass(this._slidersId).group(),this.drawColors(),this.drawSliders(),this.drawGaps();return this.setSlider({arc:0,eq:!0,level:0}),this._svg_el=document.getElementById(this._slidersId),this._svg_el.onmousedown=(e=>(this._loose=!1,this._svg_el.addEventListener("mousemove",this,!1),this._svg_el.addEventListener("mouseup",this,!1),this.handleEvent(e),!1)),this}drawColors(){const e=100/this._slider_n*.01,t=this._slider_n,s=this._arcWidth;let _;return _="hue"===this._mode?this._paint.gradient("linear",function(_){for(var i=0;i<=t;++i)_.at(e*i,`hsla(${s*i}, 100%, 50%, 1.0)`)}):this._paint.gradient("linear",function(_){for(var i=0;i<=t;++i)_.at(e*i,`hsla(0, 0%, ${s*i}%, 1.0)`)}),this._paint.rect(this._consoleWidth,M3_SLIDE_RANGE+SLIDER_EQ_HEIGHT*SLIDER_EQ_N).fill(_),this}drawSliders(){const e=DOM_getRootVar("--M3_CONSOLE_COLOR"),t=DOM_getRootVar("--M3_CONSOLE_COLOR");let s,_,i;for(s=_=i=0;s<this._slider_n;++s)this._sliders_a[s]={slider:null,cursor:null},this._sliders_a[s].slider=this._paint.rect(this._slideWidth,M3_SLIDE_RANGE).fill({color:e,opacity:1}).move(i,SLIDER_TOP),this._sliders_a[s].cursor=this._paint.line(s*this._slideWidth,SLIDER_TOP,s*this._slideWidth+this._slideWidth-2,SLIDER_TOP).stroke({color:t,width:4}),_+=this._arcWidth,i+=this._slideWidth;return this}drawGaps(){const e={color:this._gridColor,width:4};let t=this._consoleWidth;for(let s=0,_=M3_SLIDE_RANGE-1;s<SLIDER_EQ_N;++s,_+=SLIDER_EQ_HEIGHT)this._paint.line(0,_,t,_).stroke(e);return this}handleEvent(e){if(this._loose)return!1;if("mouseup"===e.type)return this._loose=!0,this._svg_el.removeEventListener("mousemove",this,!0),this._svg_el.removeEventListener("mouseup",this,!0),!1;if("mousedown"===e.type||"mousemove"===e.type){let t=this._svg_el.getBoundingClientRect();const s=e.clientX-t.left,_=e.clientY-t.top;this._lastHit=Math.floor(s/this._slideWidth);const i={arc:this._lastHit,slider_n:this._slider_n,eq:"1"===document.getElementById(this._eqInputId).value,level:0};_<M3_SLIDE_RANGE?i.level=Math.floor(_):_>M3_SLIDE_RANGE+2*SLIDER_EQ_HEIGHT?i.level=-1:_>M3_SLIDE_RANGE+SLIDER_EQ_HEIGHT&&(i.level=M3_SLIDE_RANGE),this.setSlider(i),this._handle(i)}}setSlider(e){let t=0,s=this._slider_n;for(!1===e.eq&&(t=e.arc,s=e.arc+1);t<s;++t)this._sliders_a[t].slider.opacity(e.level/M3_SLIDE_RANGE),this._sliders_a[t].cursor.move(t*this._slideWidth,SLIDER_TOP+e.level),this._levels_a[t]=e.level}getSlideWidth(){return this._slideWidth}setHit(e){this._lastHit=e}}const DOUBLE_PI=2*Math.PI,RAD_DEG=180/Math.PI;class ColorBurst{constructor(e){this._svgId=e.svgId,this._colors=e.colors,this._max=e.max,this._onHueChange=e.onHueChange||null,this._onHueTrace=e.onHueTrace||null,this._svg_el=document.getElementById(this._svgId),e.onHueChange&&this._svg_el.addEventListener("click",this,!1),e.onHueTrace&&this._svg_el.addEventListener("mousemove",this,!1)}getCoords(e,t){const s=DOUBLE_PI*e;return[Math.cos(s)*t,Math.sin(s)*t]}draw(e){const t=(e||1)/this._colors.length,s=new LogScale({minpos:0,maxpos:100,minval:0,maxval:this._max});let _=0;this._colors.forEach(e=>{if(e){const i=s.getPosition(e.frequency),[a,l]=this.getCoords(_,i);_+=t;const[n,o]=this.getCoords(_,i),r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d",`M ${a} ${l} A 1 1 0 0 1 ${n} ${o} L 0 0`),r.setAttribute("fill",e.hsl),this._svg_el.appendChild(r)}else _+=t;0})}handleEvent(e){if("mousemove"===e.type||"click"===e.type){let t=this._svg_el.getBoundingClientRect();const s=e.clientX-(t.left+t.width/2),_=e.clientY-(t.top+t.height/2);let i=Math.atan2(_,s)*RAD_DEG;return i<0&&(i+=360),this.atHue=Math.floor((i+90)%360),"mousemove"===e.type&&this._onHueTrace?this._onHueTrace(this.atHue):this._onHueChange&&this._onHueChange(this.atHue),!1}}}class AnimationFrames{constructor(e,t,s){this._frames_a=[],this._imgWidth=e,this._imgHeight=t,this.init(s)}init(e){const t=this._imgWidth/2;let s=t;const _=this._imgHeight/2;let i,a,l=_,n=0,o=0;for(let r=0;r<e.length;++r){this._frames_a[r]={offset:e[r].o/100},e[r].p&&(this._frames_a[r].opacity=e[r].p);let c="";e[r].s&&(c+=`scale(${e[r].s})`),e[r].t&&(n=e[r].t[0],a=-((o=e[r].t[1])-_),((i=-(n-t))||a)&&(c+=` translate(${i}px, ${a}px)`,s=n,l=o)),""!==c&&(this._frames_a[r].transform=c)}}getFrames(){return this._frames_a}}class OverlaySplitter{constructor(e){this._splitter_e=document.getElementById(e.splitterID),this._front_e=document.getElementById(e.frontID),this._clipClass=e.clipClass,this._clipVar=e.clipVar,this._isOn=!1}start(){this._front_e.classList.toggle(this._clipClass),this.clip(),this._splitter_e.addEventListener("click",this,!1)}pause(){this._splitter_e.removeEventListener("mousemove",this,!1)}stop(){this.pause(),this._front_e.classList.toggle(this._clipClass)}clip(e){const t=parseInt(window.getComputedStyle(this._front_e).width.replace("px",""));void 0===e&&(e=.5*t),DOM_setRootVar(this._clipVar,`${t-e}px`)}handleEvent(e){if("click"===e.type)return this._isOn?(this._isOn=!1,void this.pause()):(this._isOn=!0,void this._splitter_e.addEventListener("mousemove",this,!1));"mousemove"===e.type&&this._isOn&&this.clip(e.clientX)}}M1_process=(()=>{try{const e=document.getElementById("ca_media_1_img"),t=t=>{if(!M1_frames_a)return;DOM_setRootVar("--MEDIA_1_CURSOR","var(--CURSOR_PLAY)");const _=document.getElementById("ca_media_1_processor_anim");let i,a;({width:i,height:a}=DOM_getImgDim("ca_media_1_img"));const l=i,n=a,o=l/n,r=Math.max(document.documentElement.clientWidth,window.innerWidth||0),c=Math.max(document.documentElement.clientHeight,window.innerHeight||0);let h,d,u=.25*(r>c?c:r);(r>l||c>n)&&(u*=.75),o>0?(h=u*o,d=u):(h=u,d=u*o);let m=Math.floor(.25*l-h),g=Math.floor(.25*n-d);_.style.setProperty("clip-path",`inset(${g}px ${m}px)`),M1_frames=new AnimationFrames(l,n,M1_frames_a),e.animate(M1_frames.getFrames(),M1_anim_o),M1_imgAnim=e.getAnimations()[0],M1_imgAnim.finished.then(()=>{e.style.setProperty("opacity","1"),e.style.setProperty("transform","scale( 1 )"),_.style.setProperty("clip-path","inset(0px 0px)"),s.start(),DOM_setRootVar("--MEDIA_1_CURSOR","move")})},s=new DragElement(e);e.addEventListener("dblclick",t,!1)}catch(e){console.log(`ERROR DETECTED @M1_process: ${e}`)}}),M2_process=(()=>{try{document.getElementById("ca_media_2_img");let e,t;({width:e,height:t}=DOM_getImgDim("ca_media_2_img")),DOM_setRootVar("--MEDIA_PROCESSOR_DIM",e<t?"75vmin":"90vmin");const s=e/4,_=s,i=t/4,a=i,l="http://www.w3.org/2000/svg";let n;const o=document.getElementById("ca_media_2_processor_lines");o.setAttribute("viewBox",`0 0 ${e} ${t}`);const r=document.createElementNS(l,"g");for(r.setAttribute("id","ca_media_2_lines_v"),n=_;n<e;n+=s){const e=document.createElementNS(l,"line");e.setAttribute("x1",`${n}`),e.setAttribute("y1","0"),e.setAttribute("x2",`${n}`),e.setAttribute("y2",`${t}`),r.appendChild(e)}o.appendChild(r);const c=document.createElementNS(l,"g");for(c.setAttribute("id","ca_media_2_lines_hz"),n=a;n<t;n+=i){const t=document.createElementNS(l,"line");t.setAttribute("x1","0"),t.setAttribute("y1",`${n}`),t.setAttribute("x2",`${e}`),t.setAttribute("y2",`${n}`),c.appendChild(t)}o.appendChild(c);const h=document.createElementNS(l,"line");h.setAttribute("id","ca_media_2_lines_lr"),h.setAttribute("x1","0"),h.setAttribute("y1","0"),h.setAttribute("x2",`${e}`),h.setAttribute("y2",`${t}`),o.appendChild(h);const d=document.createElementNS(l,"line");d.setAttribute("id","ca_media_2_lines_rl"),d.setAttribute("x1",`${e}`),d.setAttribute("y1","0"),d.setAttribute("x2","0"),d.setAttribute("y2",`${t}`),o.appendChild(d);let u=0,m=0;M2_consoleInput=(e=>{let t;switch(e){case"UNDO":return u=0,void(m=0);case"lines_v":case"lines_hz":case"lines_lr":case"lines_rl":{const t=document.getElementById(`ca_media_2_${e}`);return void(t.style.opacity="0"===t.style.opacity?"1":"0")}case"ROTATE_CW":u+=90,t=`rotate(${u%=360}deg)`;break;case"ROTATE_CW_R":u-=90,t=`rotate(${u%=360}deg)`;break;case"FLIP_CW":m+=180,t=`rotateY(${m%=360}deg)`;break;case"FLIP_CW_R":m+=180,t=`rotateX(${m%=360}deg)`}t&&(document.getElementById("ca_media_2_processor").style.transform=t)})}catch(e){console.log(`ERROR DETECTED @M2_process: ${e}`)}}),M3_process=(()=>{try{const e=e=>{e?h.start():h.stop()},t=()=>{document.getElementById("ca_media_3_color_selector").classList.toggle("ca_media_3_color_selector_mute")},s=e=>{t();const s=document.getElementById("ca_media_3_processor_canvas");s.classList.toggle("ca_media_3_color_picker"),document.getElementById("ca_media_3_processor_trace").classList.toggle("ca_color_trace_show"),e?(s.addEventListener("click",l,!1),s.addEventListener("mousemove",a,!1)):(s.removeEventListener("click",l,!1),s.removeEventListener("mousemove",a,!1))},_=e=>{const t=DOM_getStyle("ca_media_3_processor_canvas","width").replace("px",""),s=M3_scan.getCanvasWidth();return M3_scan.HSL_RGBA_a(e.clientX,e.clientY,s/t)},i=e=>{const t=DOM_getStyle("ca_media_3_processor_canvas","width").replace("px",""),s=M3_scan.getCanvasWidth();return M3_scan.HSL_HSLA_a(e.clientX,e.clientY,s/t)},a=e=>{let t,s,_,a;({h:t,s:s,l:_,a:a}=i(e)),document.getElementById("ca_media_3_processor_trace_H_v").innerHTML=t,document.getElementById("ca_media_3_processor_trace_S_v").innerHTML=Math.floor(100*s),document.getElementById("ca_media_3_processor_trace_L_v").innerHTML=Math.floor(100*_),document.getElementById("ca_media_3_processor_trace_A_v").innerHTML=Math.floor(a/255*100)},l=e=>{let t,i,a,l;({r:t,g:i,b:a,a:l}=_(e)),r.setHit(RGB_H(t,i,a)),s(!1)};M3_consolePadInput=((t,_)=>{const i=document.getElementById(t),a=i.getAttribute("type"),l="1"===i.value?"0":"1";if("radio"===a){if("0"===l)return;document.querySelector('.ca_media_3_pad_input_radio[value="1"]').value="0",document.querySelector('.ca_media_3_pad_label[value="1"]').setAttribute("value","0")}i.value=l,_.setAttribute("value",l);let n=DOM_getRootVar("--M3_FE_MATRIX_RESET");switch(_.id){case"ca_media_3_split_label":return void e("1"===l);case"ca_media_3_hue_label":case"ca_media_3_lum_label":{document.getElementById("ca_media_3_selector_hue_console").classList.toggle("ca_color_selector_console_active"),document.getElementById("ca_media_3_selector_lum_console").classList.toggle("ca_color_selector_console_active");const e="ca_media_3_hue_label"===_.id?r.getSlideWidth():c.getSlideWidth();return void DOM_setRootVar("--M3_SLIDE_WIDTH",e)}case"ca_media_3_tone_label":"1"===l&&(n=H_toMatrix(r._lastHit));break;case"ca_media_3_gray_label":"1"===l&&(n=H_toMatrix(-1));break;case"ca_media_3_pick_label":s(!0);break;default:return}document.getElementById("ca_media_3_filter_matrix").setAttribute("values",n)});const n=e=>{M3_scan.setDisplay();const t="1"===document.getElementById("ca_media_3_hue_input").value?0:1;if(e.eq){if(e.level>=0){const s=e.slider_n;for(let _=0;_<s;++_)M3_scan.setOpacity(t,_,M3_SLIDE_RANGE-1-e.level)}}else e.level>=0&&M3_scan.setOpacity(t,e.arc,M3_SLIDE_RANGE-1-e.level);M3_scan.setDisplay("inline")},o=e=>{const t=DOM_getStyle("ca_media_3_selector_hue_console","left").replace("px",""),s=e.clientX-t,_=DOM_getRootVar("--M3_SLIDE_WIDTH");document.getElementById("ca_media_3_trace_label").innerHTML=`${Math.floor(s/_)}`};(M3_scan=new ColorScan({canvasId:"ca_media_3_processor_canvas",imageId:"ca_media_3_img",hue_n:M3_HUE_N,lum_n:M3_LUM_N})).setDisplay("inline").scan();const r=new ColorConsole({mode:"hue",selectorId:"ca_media_3_selector_hue_console",eqInputId:"ca_media_3_eq_input",slidersId:"ca_media_3_selector_hue_sliders",slideId:"ca_media_3_selector_slide",handle:n,slider_n:M3_HUE_N});DOM_setRootVar("--M3_SLIDE_WIDTH",r.getSlideWidth());const c=new ColorConsole({mode:"lum",selectorId:"ca_media_3_selector_lum_console",eqInputId:"ca_media_3_eq_input",slidersId:"ca_media_3_selector_lum_sliders",slideId:"ca_media_3_selector_slide",handle:n,slider_n:M3_LUM_N}),h=new OverlaySplitter({splitterID:"ca_media_3_overlay_splitter",frontID:"ca_media_3_processor_canvas",clipClass:"ca_overlay_split_clipping",clipVar:"--M3_OVERLAY_SPLIT_INSET"});document.getElementById("ca_media_3_selector_console").addEventListener("mousemove",o,!1),M4_process()}catch(e){console.log(`ERROR DETECTED @M3_process: ${e}`)}}),M4_process=(()=>{try{document.getElementById("ca_media_4_huesvg");let e,t=M3_scan.getHue_a(),s=M3_scan.getHueCount_a(),_=M3_scan.getCapacity_n(),i=t.length,a=[];for(let t=0;t<i;++t)e=s[t],a[t]=e?{frequency:e,hsl:`hsl(${t}, 100%, 50%)`}:null;const l=e=>{document.getElementById("ca_media_4_processor_trace_H_v").innerHTML=e,document.getElementById("ca_media_4_processor_trace_P_v").innerHTML=Number.parseFloat(s[e]/_*100).toFixed(2)};let n={svgId:"ca_media_4_huesvg",colors:a,maxfreq:M3_scan.getHueCountMax,onHueChange:e=>{if(!t[e]||0===t[e].length)return;const[s,_]=M3_scan.getSaturLumen_a(e),i=s.length,a=[],l=[];let n,o=0,r=0;for(let t=0;t<i;++t)(n=s[t])>o&&(o=n),a[t]=n?{frequency:n,hsl:`hsl(${e}, ${t}%, 50%)`}:null,(n=_[t])>r&&(r=n),l[t]=n?{frequency:n,hsl:`hsl(${e}, 100%, ${t}%)`}:null;DOM_resetNode("ca_media_4_processor_satID"),new ColorBurst({svgId:"ca_media_4_processor_satID",colors:a,maxfreq:o}).draw(),DOM_resetNode("ca_media_4_processor_lumID"),new ColorBurst({svgId:"ca_media_4_processor_lumID",colors:l,maxfreq:r}).draw()},onHueTrace:l};new ColorBurst(n).draw()}catch(e){console.log(`ERROR DETECTED @M4_hue_e: ${e}`)}});const M_init=()=>{const e=M_img_e.getAttribute("src"),t=document.querySelectorAll(".ca_media_processor_img");for(let s=0;s<t.length;++s)t[s].setAttribute("src",e);M1_process(),M2_process(),M3_process()},M3_HUE_N=360,M3_LUM_N=101,M3_SLIDE_RANGE=256;let M2_consoleInput,M3_consolePadInput,M3_scan;const M_img_e=document.getElementById("ca_gallery_img");!1===M_img_e.complete?M_img_e.onload=(()=>{M_init()}):M_init();

