

class ColorScan{constructor(t){this._imageId=t.imageId,this._canvasId=t.canvasId,this._hue_n=t.hue_n,this._lum_n=t.lum_n,this._type=t.type||"JPEG",this._canvas=null,this._image=null,this._context=null,this._imageData=null,this._data=null,this._capacity=0,this._display=null,this._hue_a=null,this._lum_a=null,this._hueCount_a=null,this._hueCountMax=0,this._lumCountMax_n=0,this.init()}init(){try{this._canvas=document.getElementById(this._canvasId),this._image=document.getElementById(this._imageId),this._canvas.width=this._image.width,this._canvas.height=this._image.height,this._display=this._canvas.style.display,this._context=this._canvas.getContext("2d"),this._context.drawImage(this._image,0,0),this._imageData=this._context.getImageData(0,0,this._image.width,this._image.height),this._data=this._imageData.data,this._capacity=this._data.length>>2,this._hue_a=new Array(this._hue_n);for(let t=0;t<this._hue_n;++t)this._hue_a[t]=[];this._lum_a=new Array(this._lum_n);for(let t=0;t<this._lum_n;++t)this._lum_a[t]=[]}catch(t){console.log(`[class ColorScan] init method error: ${t}`)}return this}scan(){try{console.time("scanM");const t=this._data.length;let e,s,_;for(let i=0;i<t;i+=4)e=this._data[i],s=this._data[i+1],_=this._data[i+2],this._hue_a[RGB_H(e,s,_)].push(i),this._lum_a[Math.floor(100*RGB_L(e,s,_))].push(i);return console.timeEnd("scanM"),this}catch(t){console.log(`[class ColorScan]init method error: ${t} -- at = ${at}`)}}getHue_a(){return this._hue_a}getHueCount_a(){if(null===this._hueCount_a){this._hueCount_a=new Array(this._hue_n);let t;for(let e=0;e<this._hue_n;++e)t=this._hue_a[e].length,this._hueCount_a[e]=t,t>this._hueCountMax&&(this._hueCountMax=t)}return this._hueCount_a}getHueCountMax(){return null===this._hueCount_a&&this.getHueCount_a(),this._hueCountMax}getHue_n(){return this._hue_n}getCapacity_n(){return this._capacity}getCanvasWidth(){return this._canvas.width}HSL_RGBA_a(t,e,s){const _=Math.floor(e*s)*this._canvas.width*4+4*Math.floor(t*s);return{r:this._data[_],g:this._data[_+1],b:this._data[_+2],a:this._data[_+3]}}HSL_HSLA_a(t,e,s){let _,i,a,l;return({r:_,g:i,b:a,a:l}=this.HSL_RGBA_a(t,e,s)),{h:RGB_H(_,i,a),s:RGB_S(_,i,a),l:RGB_L(_,i,a),a:l}}getSaturLumen_a(t){const e=new Int32Array(101),s=new Int32Array(101);let _=this._hue_a[t].length;for(let i=0;i<_;++i){const _=this._hue_a[t][i],a=this._data[_],l=this._data[_+1],n=this._data[_+2];e[Math.floor(100*RGB_S(a,l,n))]+=1,s[Math.floor(100*RGB_L(a,l,n))]+=1}return[e,s]}setDisplay(t){return t?(this._context.putImageData(this._imageData,0,0),this.display="inline"):this.display="none",this._canvas.style.display=this.display,this}setOpacity(t,e,s){let _;if(0===t){_=this._hue_a[e].length;for(let t=0;t<_;++t)this._data[this._hue_a[e][t]+3]=s}else{_=this._lum_a[e].length;for(let t=0;t<_;++t)this._data[this._lum_a[e][t]+3]=s}return this}}const SLIDER_TOP=0,SLIDER_UNI_HEIGHT=32,SLIDER_UNI_N=2;class ColorConsole{constructor(t){const e="hue"===t.mode?360:100;this._selectorId=t.selectorId,this._eqInputId=t.eqInputId,this._slidersId=t.slidersId,this._slideId=t.slideId,this._slider_n=t.slider_n,this._mode=t.mode,this._arcWidth=e/this._slider_n,this._slideWidth=Math.floor(.92*window.innerWidth/this._slider_n),this._consoleWidth=this._slider_n*this._slideWidth,this._gridColor=t.gridColor||DOM_getRootVar("--M3_CONSOLE_COLOR"),this._handle=t.handle,this._loose=!1,this._lastHit=0,this._paint=null,this._sliders_a=[],this._levels_a=[],DOM_setRootVar("--M3_CONSOLE_WIDTH",this._consoleWidth),this.init()}init(){this._paint=SVG(this._selectorId).size(this._consoleWidth,M3_SLIDE_RANGE+SLIDER_UNI_HEIGHT*SLIDER_UNI_N).attr("id",this._slidersId).addClass(this._slidersId).group(),this.drawColors(),this.drawSliders(),this.drawGaps();return this.setSlider({arc:0,eq:!0,level:0}),this._svg_el=document.getElementById(this._slidersId),this._svg_el.onmousedown=(t=>(this._loose=!1,this._svg_el.addEventListener("mousemove",this,!1),this._svg_el.addEventListener("mouseup",this,!1),this.handleEvent(t),!1)),this}drawColors(){const t=100/this._slider_n*.01,e=this._slider_n,s=this._arcWidth;let _;return _="hue"===this._mode?this._paint.gradient("linear",function(_){for(var i=0;i<=e;++i)_.at(t*i,`hsla(${s*i}, 100%, 50%, 1.0)`)}):this._paint.gradient("linear",function(_){for(var i=0;i<=e;++i)_.at(t*i,`hsla(0, 0%, ${s*i}%, 1.0)`)}),this._paint.rect(this._consoleWidth,M3_SLIDE_RANGE+SLIDER_UNI_HEIGHT*SLIDER_UNI_N).fill(_),this}drawSliders(){const t=DOM_getRootVar("--M3_CONSOLE_COLOR"),e=DOM_getRootVar("--M3_CONSOLE_COLOR");let s,_,i;for(s=_=i=0;s<this._slider_n;++s)this._sliders_a[s]={slider:null,cursor:null},this._sliders_a[s].slider=this._paint.rect(this._slideWidth,M3_SLIDE_RANGE).fill({color:t,opacity:1}).move(i,SLIDER_TOP),this._sliders_a[s].cursor=this._paint.line(s*this._slideWidth,SLIDER_TOP,s*this._slideWidth+this._slideWidth-2,SLIDER_TOP).stroke({color:e,width:4}),_+=this._arcWidth,i+=this._slideWidth;return this}drawGaps(){const t={color:this._gridColor,width:4};let e=this._consoleWidth;for(let s=0,_=M3_SLIDE_RANGE-1;s<SLIDER_UNI_N;++s,_+=SLIDER_UNI_HEIGHT)this._paint.line(0,_,e,_).stroke(t);return this}handleEvent(t){if(this._loose)return!1;if("mouseup"===t.type)return this._loose=!0,this._svg_el.removeEventListener("mousemove",this,!0),this._svg_el.removeEventListener("mouseup",this,!0),!1;if("mousedown"===t.type||"mousemove"===t.type){let e=this._svg_el.getBoundingClientRect();const s=t.clientX-e.left,_=t.clientY-e.top;this._lastHit=Math.floor(s/this._slideWidth);const i={arc:this._lastHit,slider_n:this._slider_n,eq:"1"===document.getElementById(this._eqInputId).value,level:0};_<M3_SLIDE_RANGE?i.level=Math.floor(_):_>M3_SLIDE_RANGE+2*SLIDER_UNI_HEIGHT?i.level=-1:_>M3_SLIDE_RANGE+SLIDER_UNI_HEIGHT&&(i.level=M3_SLIDE_RANGE),this.setSlider(i),this._handle(i)}}setSlider(t){let e=0,s=this._slider_n;for(!1===t.eq&&(e=t.arc,s=t.arc+1);e<s;++e)this._sliders_a[e].slider.opacity(t.level/M3_SLIDE_RANGE),this._sliders_a[e].cursor.move(e*this._slideWidth,SLIDER_TOP+t.level),this._levels_a[e]=t.level}getSlideWidth(){return this._slideWidth}setHit(t){this._lastHit=t}}const DOUBLE_PI=2*Math.PI,RAD_DEG=180/Math.PI;class ColorBurst{constructor(t){this._svgId=t.svgId,this._colors=t.colors,this._max=t.max,this._onHueChange=t.onHueChange||null,this._onHueTrace=t.onHueTrace||null,this._svg_el=document.getElementById(this._svgId),t.onHueChange&&this._svg_el.addEventListener("click",this,!1),t.onHueTrace&&this._svg_el.addEventListener("mousemove",this,!1)}getCoords(t,e){const s=DOUBLE_PI*t;return[Math.cos(s)*e,Math.sin(s)*e]}draw(t){const e=(t||1)/this._colors.length,s=new LogScale({minpos:0,maxpos:100,minval:0,maxval:this._max});let _=0;this._colors.forEach(t=>{if(t){const i=s.getPosition(t.frequency),[a,l]=this.getCoords(_,i);_+=e;const[n,o]=this.getCoords(_,i),r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d",`M ${a} ${l} A 1 1 0 0 1 ${n} ${o} L 0 0`),r.setAttribute("fill",t.hsl),this._svg_el.appendChild(r)}else _+=e;0})}handleEvent(t){if("mousemove"===t.type||"click"===t.type){let e=this._svg_el.getBoundingClientRect();const s=t.clientX-(e.left+e.width/2),_=t.clientY-(e.top+e.height/2);let i=Math.atan2(_,s)*RAD_DEG;return i<0&&(i+=360),this.atHue=Math.floor((i+90)%360),"mousemove"===t.type&&this._onHueTrace?this._onHueTrace(this.atHue):this._onHueChange&&this._onHueChange(this.atHue),!1}}}class AnimationFrames{constructor(t,e,s){this._frames_a=[],this._imgWidth=t,this._imgHeight=e,this.init(s)}init(t){const e=this._imgWidth/2;let s=e;const _=this._imgHeight/2;let i,a,l=_,n=0,o=0;for(let r=0;r<t.length;++r){this._frames_a[r]={offset:t[r].o/100},t[r].p&&(this._frames_a[r].opacity=t[r].p);let c="";t[r].s&&(c+=`scale(${t[r].s})`),t[r].t&&(n=t[r].t[0],a=-((o=t[r].t[1])-_),((i=-(n-e))||a)&&(c+=` translate(${i}px, ${a}px)`,s=n,l=o)),""!==c&&(this._frames_a[r].transform=c)}}getFrames(){return this._frames_a}}class OverlaySplitter{constructor(t){this._splitter_e=document.getElementById(t.splitterID),this._front_e=document.getElementById(t.frontID),this._clipClass=t.clipClass,this._clipVar=t.clipVar,this._isOn=!1}start(){this._front_e.classList.toggle(this._clipClass),this.clip(),this._splitter_e.addEventListener("click",this,!1)}pause(){this._splitter_e.removeEventListener("mousemove",this,!1)}stop(){this.pause(),this._front_e.classList.toggle(this._clipClass)}clip(t){const e=parseInt(window.getComputedStyle(this._front_e).width.replace("px",""));void 0===t&&(t=.5*e),DOM_setRootVar(this._clipVar,`${e-t}px`)}handleEvent(t){if("click"===t.type)return this._isOn?(this._isOn=!1,void this.pause()):(this._isOn=!0,void this._splitter_e.addEventListener("mousemove",this,!1));"mousemove"===t.type&&this._isOn&&this.clip(t.clientX)}}var M1_input_f;const M1_process=()=>{try{let t=null,e=null,s=null,_=!0,i=document.getElementById("ca_media_1_img"),a=document.getElementById("ca_media_1_control_play_pause").querySelectorAll(".ca_layout_switch"),l=document.getElementById("ca_media_1_control_drag_stop").querySelectorAll(".ca_layout_switch"),n=document.getElementById("ca_media_1_processor_anim");const o=()=>{null===t&&(t=new DragElement(i)),t.start(),DOM_setRootVar("--M1_CURSOR","move")},r=()=>{null===e?p():e.play(),u(),I()&&m()},c=()=>{e.pause(),u()},h=()=>{e.cancel(),E()||u(),m(),g()},d=()=>{let t=e.playbackRate;t=t<8?t+.25:.25,e.playbackRate=t},u=()=>{a[0].classList.toggle("ca_layout_switch_active"),a[1].classList.toggle("ca_layout_switch_active")},m=()=>{l[0].classList.toggle("ca_layout_switch_active"),l[1].classList.toggle("ca_layout_switch_active")},g=()=>{i.style.setProperty("opacity","1"),i.style.setProperty("transform","scale( 1 )"),n.style.setProperty("clip-path","inset(0px 0px)")},p=()=>{if(!M1_frames_a||!i||!n)return;let t,_,a=.1*Math.max(document.documentElement.clientWidth,window.innerWidth||0),l=.1*Math.max(document.documentElement.clientHeight,window.innerHeight||0);({width:t,height:_}=DOM_getImgDim("ca_media_1_img")),n.style.setProperty("clip-path",`inset(${l}px ${a}px)`),s=new AnimationFrames(t,_,M1_frames_a),(e=i.animate(s.getFrames(),M1_anim_o)).playbackRate=1},E=()=>a[0].classList.contains("ca_layout_switch_active"),I=()=>l[0].classList.contains("ca_layout_switch_active");M1_input_f=(t=>{switch(t){case"PLAY_PAUSE":E()?(r(),DOM_setRootVar("--M1_CURSOR","auto")):c();break;case"DRAG_STOP":I()?o():h();break;case"FAST_REWIND":if(null===e)break;_&&(e.reverse(),_=!1),d();break;case"FAST_FORWARD":if(null===e)break;_||(e.reverse(),_=!0),d()}})}catch(t){console.log(`ERROR DETECTED @M1_process: ${t}`)}};var M2_input_f;const M2_process=()=>{try{document.getElementById("ca_media_2_img");let t,e;({width:t,height:e}=DOM_getImgDim("ca_media_2_img")),DOM_setRootVar("--MEDIA_PROCESSOR_DIM",t<e?"75vmin":"90vmin");const s=t/4,_=s,i=e/4,a=i,l="http://www.w3.org/2000/svg";let n;const o=document.getElementById("ca_media_2_processor_lines");o.setAttribute("viewBox",`0 0 ${t} ${e}`);const r=document.createElementNS(l,"g");for(r.setAttribute("id","ca_media_2_lines_v"),n=_;n<t;n+=s){const t=document.createElementNS(l,"line");t.setAttribute("x1",`${n}`),t.setAttribute("y1","0"),t.setAttribute("x2",`${n}`),t.setAttribute("y2",`${e}`),r.appendChild(t)}o.appendChild(r);const c=document.createElementNS(l,"g");for(c.setAttribute("id","ca_media_2_lines_hz"),n=a;n<e;n+=i){const e=document.createElementNS(l,"line");e.setAttribute("x1","0"),e.setAttribute("y1",`${n}`),e.setAttribute("x2",`${t}`),e.setAttribute("y2",`${n}`),c.appendChild(e)}o.appendChild(c);const h=document.createElementNS(l,"line");h.setAttribute("id","ca_media_2_lines_lr"),h.setAttribute("x1","0"),h.setAttribute("y1","0"),h.setAttribute("x2",`${t}`),h.setAttribute("y2",`${e}`),o.appendChild(h);const d=document.createElementNS(l,"line");d.setAttribute("id","ca_media_2_lines_rl"),d.setAttribute("x1",`${t}`),d.setAttribute("y1","0"),d.setAttribute("x2","0"),d.setAttribute("y2",`${e}`),o.appendChild(d);let u=0,m=0;M2_input_f=(t=>{let e;switch(t){case"UNDO":return u=0,void(m=0);case"lines_v":case"lines_hz":case"lines_lr":case"lines_rl":{const e=document.getElementById(`ca_media_2_${t}`);return void(e.style.opacity="0"===e.style.opacity?"1":"0")}case"ROTATE_CW":u+=90,e=`rotate(${u%=360}deg)`;break;case"ROTATE_CW_R":u-=90,e=`rotate(${u%=360}deg)`;break;case"FLIP_CW":m+=180,e=`rotateY(${m%=360}deg)`;break;case"FLIP_CW_R":m+=180,e=`rotateX(${m%=360}deg)`}e&&(document.getElementById("ca_media_2_processor").style.transform=e)})}catch(t){console.log(`ERROR DETECTED @M2_process: ${t}`)}};var M3_input_f,M3_scan;const M3_SLIDE_RANGE=256,M3_process=()=>{try{const t=360,e=101,s=t=>{t?u.start():u.stop()},_=()=>{document.getElementById("ca_media_3_color_selector").classList.toggle("ca_media_3_color_selector_mute")},i=t=>{_();const e=document.getElementById("ca_media_3_processor_canvas");e.classList.toggle("ca_media_3_color_picker"),document.getElementById("ca_media_3_processor_trace").classList.toggle("ca_color_trace_show"),t?(e.addEventListener("click",o,!1),e.addEventListener("mousemove",n,!1)):(e.removeEventListener("click",o,!1),e.removeEventListener("mousemove",n,!1))},a=t=>{const e=DOM_getStyle("ca_media_3_processor_canvas","width").replace("px",""),s=M3_scan.getCanvasWidth();return M3_scan.HSL_RGBA_a(t.clientX,t.clientY,s/e)},l=t=>{const e=DOM_getStyle("ca_media_3_processor_canvas","width").replace("px",""),s=M3_scan.getCanvasWidth();return M3_scan.HSL_HSLA_a(t.clientX,t.clientY,s/e)},n=t=>{let e,s,_,i;({h:e,s:s,l:_,a:i}=l(t)),document.getElementById("ca_media_3_processor_trace_H_v").innerHTML=e,document.getElementById("ca_media_3_processor_trace_S_v").innerHTML=Math.floor(100*s),document.getElementById("ca_media_3_processor_trace_L_v").innerHTML=Math.floor(100*_),document.getElementById("ca_media_3_processor_trace_A_v").innerHTML=Math.floor(i/255*100)},o=t=>{let e,s,_,l;({r:e,g:s,b:_,a:l}=a(t)),h.setHit(RGB_H(e,s,_)),i(!1)};M3_input_f=((t,e)=>{const _=document.getElementById(t),a=_.getAttribute("type"),l="1"===_.value?"0":"1";if("radio"===a){if("0"===l)return;document.querySelector('.ca_media_3_pad_input_radio[value="1"]').value="0",document.querySelector('.ca_media_3_pad_label[value="1"]').setAttribute("value","0")}_.value=l,e.setAttribute("value",l);let n=DOM_getRootVar("--M3_FE_MATRIX_RESET");switch(e.id){case"ca_media_3_split_label":return void s("1"===l);case"ca_media_3_hue_label":case"ca_media_3_lum_label":{document.getElementById("ca_media_3_selector_hue_console").classList.toggle("ca_color_selector_console_active"),document.getElementById("ca_media_3_selector_lum_console").classList.toggle("ca_color_selector_console_active");const t="ca_media_3_hue_label"===e.id?h.getSlideWidth():d.getSlideWidth();return void DOM_setRootVar("--M3_SLIDE_WIDTH",t)}case"ca_media_3_tone_label":"1"===l&&(n=H_toMatrix(h._lastHit));break;case"ca_media_3_gray_label":"1"===l&&(n=H_toMatrix(-1));break;case"ca_media_3_pick_label":i(!0);break;default:return}document.getElementById("ca_media_3_filter_matrix").setAttribute("values",n)});const r=t=>{M3_scan.setDisplay();const e="1"===document.getElementById("ca_media_3_hue_input").value?0:1;if(t.eq){if(t.level>=0){const s=t.slider_n;for(let _=0;_<s;++_)M3_scan.setOpacity(e,_,M3_SLIDE_RANGE-1-t.level)}}else t.level>=0&&M3_scan.setOpacity(e,t.arc,M3_SLIDE_RANGE-1-t.level);M3_scan.setDisplay("inline")},c=t=>{const e=DOM_getStyle("ca_media_3_selector_hue_console","left").replace("px",""),s=t.clientX-e,_=DOM_getRootVar("--M3_SLIDE_WIDTH");document.getElementById("ca_media_3_trace_label").innerHTML=`${Math.floor(s/_)}`};(M3_scan=new ColorScan({canvasId:"ca_media_3_processor_canvas",imageId:"ca_media_3_img",hue_n:t,lum_n:e})).setDisplay("inline").scan();const h=new ColorConsole({mode:"hue",selectorId:"ca_media_3_selector_hue_console",eqInputId:"ca_media_3_uni_input",slidersId:"ca_media_3_selector_hue_sliders",slideId:"ca_media_3_selector_slide",handle:r,slider_n:t});DOM_setRootVar("--M3_SLIDE_WIDTH",h.getSlideWidth());const d=new ColorConsole({mode:"lum",selectorId:"ca_media_3_selector_lum_console",eqInputId:"ca_media_3_uni_input",slidersId:"ca_media_3_selector_lum_sliders",slideId:"ca_media_3_selector_slide",handle:r,slider_n:e}),u=new OverlaySplitter({splitterID:"ca_media_3_processor_overlay",frontID:"ca_media_3_processor_canvas",clipClass:"ca_overlay_split_clipping",clipVar:"--M3_OVERLAY_SPLIT_INSET"});document.getElementById("ca_media_3_selector_console").addEventListener("mousemove",c,!1),M4_process()}catch(t){console.log(`ERROR DETECTED @M3_process: ${t}`)}},M4_process=()=>{try{document.getElementById("ca_media_4_huesvg");let t,e=M3_scan.getHue_a(),s=M3_scan.getHueCount_a(),_=M3_scan.getCapacity_n(),i=e.length,a=[];for(let e=0;e<i;++e)t=s[e],a[e]=t?{frequency:t,hsl:`hsl(${e}, 100%, 50%)`}:null;const l=t=>{document.getElementById("ca_media_4_processor_trace_H_v").innerHTML=t,document.getElementById("ca_media_4_processor_trace_P_v").innerHTML=Number.parseFloat(s[t]/_*100).toFixed(2)};let n={svgId:"ca_media_4_huesvg",colors:a,maxfreq:M3_scan.getHueCountMax,onHueChange:t=>{if(!e[t]||0===e[t].length)return;const[s,_]=M3_scan.getSaturLumen_a(t),i=s.length,a=[],l=[];let n,o=0,r=0;for(let e=0;e<i;++e)(n=s[e])>o&&(o=n),a[e]=n?{frequency:n,hsl:`hsl(${t}, ${e}%, 50%)`}:null,(n=_[e])>r&&(r=n),l[e]=n?{frequency:n,hsl:`hsl(${t}, 100%, ${e}%)`}:null;DOM_resetNode("ca_media_4_processor_satID"),new ColorBurst({svgId:"ca_media_4_processor_satID",colors:a,maxfreq:o}).draw(),DOM_resetNode("ca_media_4_processor_lumID"),new ColorBurst({svgId:"ca_media_4_processor_lumID",colors:l,maxfreq:r}).draw()},onHueTrace:l};new ColorBurst(n).draw()}catch(t){console.log(`ERROR DETECTED @M4_hue_e: ${t}`)}},M_init=()=>{try{const t=M_img_e.getAttribute("src");document.querySelectorAll(".ca_media_processor_img").forEach(e=>e.setAttribute("src",t)),M1_process(),M2_process(),M3_process()}catch(t){console.log(`ERROR DETECTED @M_init: ${t}`)}},M_img_e=document.getElementById("ca_gallery_img");!1===M_img_e.complete?M_img_e.onload=(()=>M_init()):M_init();

