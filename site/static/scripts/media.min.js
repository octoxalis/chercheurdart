
class DOM_FeColorMatrix{constructor(t,e,s){this._animateID=e||"ca_animate",this._filter_e=document.getElementById(t),this.createMatrix(s)}toMatrix(t){return{from_s:`${t.r0} 0 0 0 0    0 ${t.g0} 0 0 0    0 0 ${t.b0} 0 0    0 0 0 1 0`,to_s:`${t.r1} 0 0 0 0    0 ${t.g1} 0 0 0    0 0 ${t.b1} 0 0    0 0 0 1 0`}}toBegin(t,e){let s=void 0!==e?`${e}s;`:"";return void 0!==t&&(s+=`${t}.end`),s}toDuration(t){return`${t.d}s`}createAnimate(t,e){const s=document.createElementNS("http://www.w3.org/2000/svg","animate");let i,_;return s.setAttribute("id",`${this._animateID}_${t}`),s.setAttribute("attributeType","XML"),s.setAttribute("attributeName","values"),s.setAttribute("dur",this.toDuration(e)),s.setAttribute("repeatCount",1),({from_s:i,to_s:_}=this.toMatrix(e)),s.setAttribute("from",i),s.setAttribute("to",_),s}createMatrix(t){const e=t.length-1;for(let s=0;s<=e;++s){const i=this.createAnimate(s,t[s]),_=0===s?this.toBegin(`${this._animateID}_${e}`,0):this.toBegin(`${this._animateID}_${s-1}`);i.setAttribute("begin",_),this._filter_e.appendChild(i)}}}class ColorScan{constructor(t){this._imageId=t.imageId,this._canvasId=t.canvasId,this._hue_n=t.hue_n,this._lum_n=t.lum_n,this._type=t.type||"JPEG",this._canvas=null,this._image=null,this._context=null,this._imageData=null,this._data=null,this._display=null,this._hue_a=null,this._lum_a=null,this.init()}init(){try{this._canvas=document.getElementById(this._canvasId),this._image=document.getElementById(this._imageId),this._canvas.width=this._image.width,this._canvas.height=this._image.height,this._display=this._canvas.style.display,this._context=this._canvas.getContext("2d"),this._context.drawImage(this._image,0,0),this._imageData=this._context.getImageData(0,0,this._image.width,this._image.height),this._data=this._imageData.data,this._hue_a=new Array(this._hue_n);for(let t=0;t<this._hue_n;++t)this._hue_a[t]=[];this._lum_a=new Array(this._lum_n);for(let t=0;t<this._lum_n;++t)this._lum_a[t]=[]}catch(t){console.log(`[class ColorScan]init method error: ${t}`)}return this}scan(){try{console.time("scanM");const t=this._data.length;let e,s,i;for(let _=0;_<t;_+=4)e=this._data[_],s=this._data[_+1],i=this._data[_+2],this._hue_a[RGB_H(e,s,i)].push(_),this._lum_a[Math.floor(100*RGB_L(e,s,i))].push(_);return console.timeEnd("scanM"),this}catch(t){console.log(`[class ColorScan]init method error: ${t} -- at = ${at}`)}}getHue_a(){return this._hue_a}getHue_n(){return this._hue_n}getCanvasWidth(){return this._canvas.width}HSL_RGBA_a(t,e,s){const i=Math.floor(e*s)*this._canvas.width*4+4*Math.floor(t*s);return{r:this._data[i],g:this._data[i+1],b:this._data[i+2],a:this._data[i+3]}}HSL_HSLA_a(t,e,s){let i,_,a,l;return({r:i,g:_,b:a,a:l}=this.HSL_RGBA_a(t,e,s)),{h:RGB_H(i,_,a),s:RGB_S(i,_,a),l:RGB_L(i,_,a),a:l}}getSaturLumen_a(t){const e=new Int32Array(101),s=new Int32Array(101);let i=this._hue_a[t].length;for(let _=0;_<i;++_){const i=this._hue_a[t][_],a=this._data[i],l=this._data[i+1],o=this._data[i+2];e[Math.floor(100*RGB_S(a,l,o))]+=1,s[Math.floor(100*RGB_L(a,l,o))]+=1}return[e,s]}setDisplay(t){return t?(this._context.putImageData(this._imageData,0,0),this.display="inline"):this.display="none",this._canvas.style.display=this.display,this}setOpacity(t,e,s){let i;if(0===t){i=this._hue_a[e].length;for(let t=0;t<i;++t)this._data[this._hue_a[e][t]+3]=s}else{i=this._lum_a[e].length;for(let t=0;t<i;++t)this._data[this._lum_a[e][t]+3]=s}return this}}const SLIDER_TOP=0,SLIDER_EQ_HEIGHT=32,SLIDER_EQ_N=2;class ColorConsole{constructor(t){const e="hue"===t.mode?360:100;this._selectorId=t.selectorId,this._eqInputId=t.eqInputId,this._slidersId=t.slidersId,this._slideId=t.slideId,this._slider_n=t.slider_n,this._mode=t.mode,this._arcWidth=e/this._slider_n,this._slideWidth=Math.floor(.92*window.innerWidth/this._slider_n),this._consoleWidth=this._slider_n*this._slideWidth,this._gridColor=t.gridColor||DOM_getRootVar("--M3_CONSOLE_COLOR"),this._handle=t.handle,this._loose=!1,this._lastHit=0,this._paint=null,this._sliders_a=[],this._levels_a=[],DOM_setRootVar("--M3_CONSOLE_WIDTH",this._consoleWidth),this.init()}init(){this._paint=SVG(this._selectorId).size(this._consoleWidth,M3_SLIDE_RANGE+SLIDER_EQ_HEIGHT*SLIDER_EQ_N).attr("id",this._slidersId).addClass(this._slidersId).group(),this.drawColors(),this.drawSliders(),this.drawGaps();return this.setSlider({arc:0,eq:!0,level:0}),this._svg_el=document.getElementById(this._slidersId),this._svg_el.onmousedown=(t=>(this._loose=!1,this._svg_el.addEventListener("mousemove",this,!1),this._svg_el.addEventListener("mouseup",this,!1),this.handleEvent(t),!1)),this}drawColors(){const t=100/this._slider_n*.01,e=this._slider_n,s=this._arcWidth;let i;return i="hue"===this._mode?this._paint.gradient("linear",function(i){for(var _=0;_<=e;++_)i.at(t*_,`hsla(${s*_}, 100%, 50%, 1.0)`)}):this._paint.gradient("linear",function(i){for(var _=0;_<=e;++_)i.at(t*_,`hsla(0, 0%, ${s*_}%, 1.0)`)}),this._paint.rect(this._consoleWidth,M3_SLIDE_RANGE+SLIDER_EQ_HEIGHT*SLIDER_EQ_N).fill(i),this}drawSliders(){const t=DOM_getRootVar("--M3_CONSOLE_COLOR"),e=DOM_getRootVar("--M3_CONSOLE_COLOR");let s,i,_;for(s=i=_=0;s<this._slider_n;++s)this._sliders_a[s]={slider:null,cursor:null},this._sliders_a[s].slider=this._paint.rect(this._slideWidth,M3_SLIDE_RANGE).fill({color:t,opacity:1}).move(_,SLIDER_TOP),this._sliders_a[s].cursor=this._paint.line(s*this._slideWidth,SLIDER_TOP,s*this._slideWidth+this._slideWidth-2,SLIDER_TOP).stroke({color:e,width:4}),i+=this._arcWidth,_+=this._slideWidth;return this}drawGaps(){const t={color:this._gridColor,width:4};let e=this._consoleWidth;for(let s=0,i=M3_SLIDE_RANGE-1;s<SLIDER_EQ_N;++s,i+=SLIDER_EQ_HEIGHT)this._paint.line(0,i,e,i).stroke(t);return this}handleEvent(t){if(this._loose)return!1;if("mouseup"===t.type)return this._loose=!0,this._svg_el.removeEventListener("mousemove",this,!0),this._svg_el.removeEventListener("mouseup",this,!0),!1;if("mousedown"===t.type||"mousemove"===t.type){let e=this._svg_el.getBoundingClientRect();const s=t.clientX-e.left,i=t.clientY-e.top;this._lastHit=Math.floor(s/this._slideWidth);const _={arc:this._lastHit,slider_n:this._slider_n,eq:"1"===document.getElementById(this._eqInputId).value,level:0};i<M3_SLIDE_RANGE?_.level=Math.floor(i):i>M3_SLIDE_RANGE+2*SLIDER_EQ_HEIGHT?_.level=-1:i>M3_SLIDE_RANGE+SLIDER_EQ_HEIGHT&&(_.level=M3_SLIDE_RANGE),this.setSlider(_),this._handle(_)}}setSlider(t){let e=0,s=this._slider_n;for(!1===t.eq&&(e=t.arc,s=t.arc+1);e<s;++e)this._sliders_a[e].slider.opacity(t.level/M3_SLIDE_RANGE),this._sliders_a[e].cursor.move(e*this._slideWidth,SLIDER_TOP+t.level),this._levels_a[e]=t.level}getSlideWidth(){return this._slideWidth}setHit(t){this._lastHit=t}}const DOUBLE_PI=2*Math.PI,RAD_DEG=180/Math.PI;class ColorBurst{constructor(t){this._svgId=t.svgId,this._colors=t.colors,this._max=t.max,this._onHueChange=t.onHueChange||null,this._svg_el=document.getElementById(this._svgId),t.onHueChange&&this._svg_el.addEventListener("click",this,!1)}getCoords(t,e){const s=DOUBLE_PI*t;return[Math.cos(s)*e,Math.sin(s)*e]}draw(t){const e=(t||1)/this._colors.length,s=new LogScale({minpos:0,maxpos:100,minval:0,maxval:this._max});let i=0;this._colors.forEach(t=>{if(t){const _=s.getPosition(t.frequency),[a,l]=this.getCoords(i,_);i+=e;const[o,n]=this.getCoords(i,_),r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d",`M ${a} ${l} A 1 1 0 0 1 ${o} ${n} L 0 0`),r.setAttribute("fill",t.hsl),this._svg_el.appendChild(r)}else i+=e;0})}handleEvent(t){if("click"===t.type){let e=this._svg_el.getBoundingClientRect();const s=t.clientX-(e.left+e.width/2),i=t.clientY-(e.top+e.height/2);let _=Math.atan2(i,s)*RAD_DEG;return _<0&&(_+=360),this.atHue=Math.floor((_+90)%360),this._onHueChange&&this._onHueChange(this.atHue),!1}}}class AnimationFrames{constructor(t,e,s){this._frames_a=[],this._imgWidth=t,this._imgHeight=e,this.init(s)}init(t){const e=this._imgWidth/2;let s=e;const i=this._imgHeight/2;let _,a,l=i,o=0,n=0;for(let r=0;r<t.length;++r){this._frames_a[r]={offset:t[r].o/100},t[r].p&&(this._frames_a[r].opacity=t[r].p);let c="";t[r].s&&(c+=`scale(${t[r].s})`),t[r].t&&(o=t[r].t[0],a=-((n=t[r].t[1])-i),((_=-(o-e))||a)&&(c+=` translate(${_}px, ${a}px)`,s=o,l=n)),""!==c&&(this._frames_a[r].transform=c)}}getFrames(){return this._frames_a}}class OverlaySplitter{constructor(t){this._splitter_e=document.getElementById(t.splitterID),this._front_e=document.getElementById(t.frontID),this._clipClass=t.clipClass,this._clipVar=t.clipVar,this._isOn=!1}start(){this._front_e.classList.toggle(this._clipClass),this.clip(),this._splitter_e.addEventListener("click",this,!1)}pause(){this._splitter_e.removeEventListener("mousemove",this,!1)}stop(){this.pause(),this._front_e.classList.toggle(this._clipClass)}clip(t){const e=parseInt(window.getComputedStyle(this._front_e).width.replace("px",""));void 0===t&&(t=.5*e),DOM_setRootVar(this._clipVar,`${e-t}px`)}handleEvent(t){if("click"===t.type)return this._isOn?(this._isOn=!1,void this.pause()):(this._isOn=!0,void this._splitter_e.addEventListener("mousemove",this,!1));"mousemove"===t.type&&this._isOn&&this.clip(t.clientX)}}M1_process=(()=>{try{const t=document.getElementById("ca_media_1_img"),e=e=>{if(!M1_frames_a)return;DOM_setRootVar("--MEDIA_1_CURSOR","var(--CURSOR_PLAY)");const i=document.getElementById("ca_media_1_processor_anim");let _,a;({width:_,height:a}=DOM_getImgDim("ca_media_1_img"));const l=_,o=a,n=l/o,r=Math.max(document.documentElement.clientWidth,window.innerWidth||0),c=Math.max(document.documentElement.clientHeight,window.innerHeight||0);let h,d,m=.25*(r>c?c:r);(r>l||c>o)&&(m*=.75),n>0?(h=m*n,d=m):(h=m,d=m*n);let u=Math.floor(.25*l-h),g=Math.floor(.25*o-d);i.style.setProperty("clip-path",`inset(${g}px ${u}px)`),M1_frames=new AnimationFrames(l,o,M1_frames_a),t.animate(M1_frames.getFrames(),M1_anim_o),M1_imgAnim=t.getAnimations()[0],M1_imgAnim.finished.then(()=>{t.style.setProperty("opacity","1"),t.style.setProperty("transform","scale( 1 )"),i.style.setProperty("clip-path","inset(0px 0px)"),s.start(),DOM_setRootVar("--MEDIA_1_CURSOR","move")})},s=new DragElement(t);t.addEventListener("dblclick",e,!1)}catch(t){console.log(`ERROR DETECTED @M1_process: ${t}`)}}),M2_process=(()=>{try{document.getElementById("ca_media_2_img");let t,e;({width:t,height:e}=DOM_getImgDim("ca_media_2_img")),DOM_setRootVar("--MEDIA_PROCESSOR_DIM",t<e?"75vmin":"90vmin");const s=t/4,i=s,_=e/4,a=_,l="http://www.w3.org/2000/svg";let o;const n=document.getElementById("ca_media_2_processor_lines");n.setAttribute("viewBox",`0 0 ${t} ${e}`);const r=document.createElementNS(l,"g");for(r.setAttribute("id","ca_media_2_lines_v"),o=i;o<t;o+=s){const t=document.createElementNS(l,"line");t.setAttribute("x1",`${o}`),t.setAttribute("y1","0"),t.setAttribute("x2",`${o}`),t.setAttribute("y2",`${e}`),r.appendChild(t)}n.appendChild(r);const c=document.createElementNS(l,"g");for(c.setAttribute("id","ca_media_2_lines_hz"),o=a;o<e;o+=_){const e=document.createElementNS(l,"line");e.setAttribute("x1","0"),e.setAttribute("y1",`${o}`),e.setAttribute("x2",`${t}`),e.setAttribute("y2",`${o}`),c.appendChild(e)}n.appendChild(c);const h=document.createElementNS(l,"line");h.setAttribute("id","ca_media_2_lines_lr"),h.setAttribute("x1","0"),h.setAttribute("y1","0"),h.setAttribute("x2",`${t}`),h.setAttribute("y2",`${e}`),n.appendChild(h);const d=document.createElementNS(l,"line");d.setAttribute("id","ca_media_2_lines_rl"),d.setAttribute("x1",`${t}`),d.setAttribute("y1","0"),d.setAttribute("x2","0"),d.setAttribute("y2",`${e}`),n.appendChild(d);let m=0,u=0;M2_consoleInput=(t=>{let e;switch(t){case"UNDO":return m=0,void(u=0);case"lines_v":case"lines_hz":case"lines_lr":case"lines_rl":{const e=document.getElementById(`ca_media_2_${t}`);return void(e.style.opacity="0"===e.style.opacity?"1":"0")}case"ROTATE_CW":m+=90,e=`rotate(${m%=360}deg)`;break;case"ROTATE_CW_R":m-=90,e=`rotate(${m%=360}deg)`;break;case"FLIP_CW":u+=180,e=`rotateY(${u%=360}deg)`;break;case"FLIP_CW_R":u+=180,e=`rotateX(${u%=360}deg)`}e&&(document.getElementById("ca_media_2_processor").style.transform=e)})}catch(t){console.log(`ERROR DETECTED @M2_process: ${t}`)}}),M3_process=(()=>{try{const t=t=>{t?h.start():h.stop()},e=()=>{document.getElementById("ca_media_3_color_selector").classList.toggle("ca_media_3_color_selector_mute")},s=t=>{e();const s=document.getElementById("ca_media_3_processor_canvas");s.classList.toggle("ca_media_3_color_picker"),document.getElementById("ca_color_processor_trace").classList.toggle("ca_color_trace_show"),t?(s.addEventListener("click",l,!1),s.addEventListener("mousemove",a,!1)):(s.removeEventListener("click",l,!1),s.removeEventListener("mousemove",a,!1))},i=t=>{const e=DOM_getStyle("ca_media_3_processor_canvas","width").replace("px",""),s=M3_scan.getCanvasWidth();return M3_scan.HSL_RGBA_a(t.clientX,t.clientY,s/e)},_=t=>{const e=DOM_getStyle("ca_media_3_processor_canvas","width").replace("px",""),s=M3_scan.getCanvasWidth();return M3_scan.HSL_HSLA_a(t.clientX,t.clientY,s/e)},a=t=>{let e,s,i,a;({h:e,s:s,l:i,a:a}=_(t)),document.getElementById("ca_color_processor_trace").innerHTML=`H:${e} S:${Math.floor(100*s)} L:${Math.floor(100*i)} A:${Math.floor(a/255*100)}`},l=t=>{let e,_,a,l;({r:e,g:_,b:a,a:l}=i(t)),r.setHit(RGB_H(e,_,a)),s(!1)};M3_consolePadInput=((e,i)=>{const _=document.getElementById(e),a=_.getAttribute("type"),l="1"===_.value?"0":"1";if("radio"===a){if("0"===l)return;document.querySelector('.ca_media_3_pad_input_radio[value="1"]').value="0",document.querySelector('.ca_media_3_pad_label[value="1"]').setAttribute("value","0")}_.value=l,i.setAttribute("value",l);let o=DOM_getRootVar("--M3_FE_MATRIX_RESET");switch(i.id){case"ca_media_3_split_label":return void t("1"===l);case"ca_media_3_hue_label":case"ca_media_3_lum_label":{document.getElementById("ca_media_3_selector_hue_console").classList.toggle("ca_color_selector_console_active"),document.getElementById("ca_media_3_selector_lum_console").classList.toggle("ca_color_selector_console_active");const t="ca_media_3_hue_label"===i.id?r.getSlideWidth():c.getSlideWidth();return void DOM_setRootVar("--M3_SLIDE_WIDTH",t)}case"ca_media_3_tone_label":"1"===l&&(o=H_toMatrix(r._lastHit));break;case"ca_media_3_gray_label":"1"===l&&(o=H_toMatrix(-1));break;case"ca_media_3_pick_label":s(!0);break;default:return}document.getElementById("ca_media_3_filter_matrix").setAttribute("values",o)});const o=t=>{M3_scan.setDisplay();const e="1"===document.getElementById("ca_media_3_hue_input").value?0:1;if(t.eq){if(t.level>=0){const s=t.slider_n;for(let i=0;i<s;++i)M3_scan.setOpacity(e,i,M3_SLIDE_RANGE-1-t.level)}}else t.level>=0&&M3_scan.setOpacity(e,t.arc,M3_SLIDE_RANGE-1-t.level);M3_scan.setDisplay("inline")},n=t=>{const e=DOM_getStyle("ca_media_3_selector_hue_console","left").replace("px",""),s=t.clientX-e,i=DOM_getRootVar("--M3_SLIDE_WIDTH");document.getElementById("ca_color_selector_trace").innerHTML=`${Math.floor(s/i)}`};(M3_scan=new ColorScan({canvasId:"ca_media_3_processor_canvas",imageId:"ca_media_3_img",hue_n:M3_HUE_N,lum_n:M3_LUM_N})).setDisplay("inline").scan();const r=new ColorConsole({mode:"hue",selectorId:"ca_media_3_selector_hue_console",eqInputId:"ca_media_3_eq_input",slidersId:"ca_media_3_selector_hue_sliders",slideId:"ca_media_3_selector_slide",handle:o,slider_n:M3_HUE_N});DOM_setRootVar("--M3_SLIDE_WIDTH",r.getSlideWidth());const c=new ColorConsole({mode:"lum",selectorId:"ca_media_3_selector_lum_console",eqInputId:"ca_media_3_eq_input",slidersId:"ca_media_3_selector_lum_sliders",slideId:"ca_media_3_selector_slide",handle:o,slider_n:M3_LUM_N}),h=new OverlaySplitter({splitterID:"ca_media_3_overlay_splitter",frontID:"ca_media_3_processor_canvas",clipClass:"ca_overlay_split_clipping",clipVar:"--M3_OVERLAY_SPLIT_INSET"});document.getElementById("ca_media_3_selector_console").addEventListener("mousemove",n,!1),M4_process()}catch(t){console.log(`ERROR DETECTED @M3_process: ${t}`)}}),M4_process=(()=>{try{document.getElementById("ca_media_4_huesvg");let t,e=M3_scan.getHue_a(),s=M3_HUE_N,i=[],_=0;for(let a=0;a<s;++a)(t=e[a].length)>_&&(_=t),i[a]=t?{frequency:t,hsl:`hsl(${a}, 100%, 50%)`}:null;new ColorBurst({svgId:"ca_media_4_huesvg",colors:i,maxfreq:_,onHueChange:t=>{if(!e[t]||0===e[t].length)return;const[s,i]=M3_scan.getSaturLumen_a(t),_=s.length,a=[],l=[];let o,n=0,r=0;for(let e=0;e<_;++e)(o=s[e])>n&&(n=o),a[e]=o?{frequency:o,hsl:`hsl(${t}, ${e}%, 50%)`}:null,(o=i[e])>r&&(r=o),l[e]=o?{frequency:o,hsl:`hsl(${t}, 100%, ${e}%)`}:null;DOM_resetNode("ca_media_4_processor_satID"),new ColorBurst({svgId:"ca_media_4_processor_satID",colors:a,maxfreq:n}).draw(),DOM_resetNode("ca_media_4_processor_lumID"),new ColorBurst({svgId:"ca_media_4_processor_lumID",colors:l,maxfreq:r}).draw()}}).draw()}catch(t){console.log(`ERROR DETECTED @M4_hue_e: ${t}`)}});const M_init=()=>{const t=M_img_e.getAttribute("src"),e=document.querySelectorAll(".ca_media_processor_img");for(let s=0;s<e.length;++s)e[s].setAttribute("src",t);M1_process(),M2_process(),M3_process()},M3_HUE_N=360,M3_LUM_N=101,M3_SLIDE_RANGE=256;let M2_consoleInput,M3_consolePadInput,M3_scan;const M_img_e=document.getElementById("ca_gallery_img");!1===M_img_e.complete?M_img_e.onload=(()=>{M_init()}):M_init();
