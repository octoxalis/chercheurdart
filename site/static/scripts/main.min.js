
class KVIdb{constructor(e="kv_db",t="kv_store",s=1){this.idb=null,this.idb_s=e,this.store=t,this.version=s,this.ready=null,this.init()}init(){this.ready=new Promise((e,t)=>{const s=window.indexedDB.open(this.idb_s,this.version);s.onupgradeneeded=(e=>{this.idb=e.target.result,this.idb.createObjectStore(this.store)}),s.onsuccess=(t=>{this.idb=t.target.result,e(t.target.result)}),s.onerror=(e=>t(e.target.error))})}get(e){return this.ready.then(()=>new Promise((t,s)=>{const r=this.idb.transaction([this.store],"readonly").objectStore(this.store).get(e);r.onsuccess=(e=>t(e.target.result)),r.onerror=s}))}walk(e){return this.ready.then(()=>new Promise((t,s)=>{const r=this.idb.transaction([this.store],"readonly").objectStore(this.store).openCursor();r.onsuccess=(s=>{let r=s.target.result;r?(e(r.key,r.value),r.continue()):t()}),r.onerror=s}))}last(){return this.ready.then(()=>new Promise((e,t)=>{const s=this.idb.transaction([this.store],"readonly").objectStore(this.store).openCursor(null,"prev");s.onsuccess=(t=>{t.target.result&&e(t.target.result.value)}),s.onerror=t}))}set(e,t){return this.ready.then(()=>new Promise((s,r)=>{const o=this.idb.transaction([this.store],"readwrite").objectStore(this.store).put(t,e);o.onsuccess=s,o.onerror=r}))}update(e,t,s){return this.ready.then(()=>new Promise((r,o)=>{const a=this.idb.transaction([this.store],"readwrite").objectStore(this.store),n=a.get(e);n.onsuccess=(()=>{const i=n.result;i[t]=s;const c=a.put(i,e);c.onsuccess=r,c.onerror=o}),n.onerror=o}))}deleteAll(e){return this.ready.then(()=>new Promise((t,s)=>{const r=this.idb.transaction([this.store],"readwrite").objectStore(this.store),o=r.openCursor();o.onsuccess=(t=>{let s,o=t.target.result;o&&(s=o.value,e(s)&&r.delete(o.key),o.continue())}),o.onerror=s}))}delete(e){return this.ready.then(()=>new Promise((t,s)=>{const r=this.idb.transaction([this.store],"readwrite").objectStore(this.store).delete(e);r.onsuccess=t,r.onerror=s}))}clear(){return this.ready.then(()=>new Promise((e,t)=>{const s=this.idb.transaction([this.store],"readwrite").objectStore(this.store).clear();s.onsuccess=e,s.onerror=t}))}deleteIDB(){window.indexedDB.deleteDatabase(this.idb_s)}}const A_unshift=(e,t)=>{let s=e.length;for(;s;)e[s]=e[s-1],--s;e[0]=t},A_splice=(e,t)=>{let s=e.length;if(s){for(;t<s;)e[t]=e[t+1],++t;--e.length}},A_indexOf=(e,t)=>{for(let s=0,r=e.length;s!=r;s++)if(e[s]===t)return s;return-1},A_lastIndexOf=(e,t)=>{let s=e.length;for(;s--&&e[s]!==t;);return s},A_fill=(e,t)=>{const s=new Array(e);for(;--e>=0;)s[e]=t;return s},dateAsLocale=(e=null)=>{let t=e?new Date(e):new Date;const s=t.getFullYear(),r=t.getMonth()+1,o=r<10?`0${r}`:`${r}`,a=t.getDate();return{now_s:`${s}-${o}-${a<10?`0${a}`:`${a}`}`,locale_s:t.toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"})}},cyrb53=(e,t=0)=>{let s=3735928559^t,r=1103547991^t;for(let t,o=0;o<e.length;++o)t=e.charCodeAt(o),s=Math.imul(s^t,2654435761),r=Math.imul(r^t,1597334677);return s=Math.imul(s^s>>>16,2246822507)^Math.imul(r^r>>>13,3266489909),4294967296*(2097151&(r=Math.imul(r^r>>>16,2246822507)^Math.imul(s^s>>>13,3266489909)))+(s>>>0)},DOM_setRootVar=(e,t)=>{document.documentElement.style.setProperty(e,t)},DOM_getRootVar=e=>getComputedStyle(document.documentElement).getPropertyValue(e)||"",DOM_resetNode=e=>{const t=document.getElementById(e);for(;t.firstChild;)t.removeChild(t.firstChild)},DOM_getStyle=(e,t)=>{let s=document.getElementById(e);return s?window.getComputedStyle(s).getPropertyValue(t):""},DOM_getImgDim=e=>{const t=document.getElementById(e);return{width:t.getAttribute("data-src-width"),height:t.getAttribute("data-src-height")}},DOM_strimHTML=e=>e.replace(/(<([^>]+)>)/gi,""),DOM_openFolder=e=>{e.nextElementSibling.classList.toggle("ca_is_open"),e.parentElement.classList.toggle("ca_has_open")},DOM_openFolderAll=()=>{const e=document.getElementById("ca_folder_opener"),t=e.classList.contains("_ca_folder_opener_");e.classList.toggle("_ca_folder_opener_");const s=document.getElementById("ca_folder_container_inner").querySelectorAll(".ca_fold_content");let r;for(let e of s)if(t){e.classList.remove("ca_has_open"),r=e.querySelectorAll(".ca_fold_content_item");for(let e of r)e.classList.remove("ca_is_open")}else{e.classList.add("ca_has_open"),r=e.querySelectorAll(".ca_fold_content_item");for(let e of r)e.classList.add("ca_is_open")}},DOM_dialog=(e,t)=>{const s=e.type;if(dialog_e=document.getElementById(`ca_dialog_is_${s}`),t||"function"!=typeof dialog_e.showModal){const t=e.mark?DOM_strimHTML(e.mark):"";return void window.alert(`${e.header||""}: ${e.content||""} (${t})`)}if(e.header&&(document.getElementById(`ca_dialog_header_is_${s}`).innerHTML=e.header),e.content&&(document.getElementById(`ca_dialog_content_is_${s}`).innerHTML=e.content+(e.mark?e.mark:"")),void 0===e.options_a){const e=document.getElementById(`ca_dialog_options_is_${s}`);e&&e.classList.add("ca_dialog_option_hidden")}else{options_e=document.getElementById(`ca_dialog_options_is_${s}`),options_e.classList.remove("ca_dialog_option_hidden");const t=options_e.querySelectorAll("li");for(let s=0;s<t.length;++s){const r=t[s].classList.contains("ca_dialog_option_hidden");e.options_a[s]?(t[s].innerHTML=e.options_a[s],t[s].classList.remove("ca_dialog_option_hidden"),t[s].addEventListener("click",()=>{e.result=t[s].id,e.callback_f&&e.callback_f(e.result),dialog_e.close(e.result)})):r||t[s].classList.add("ca_dialog_option_hidden")}}const r=e.cancel||"cancelled";document.getElementById(`ca_dialog_close_is_${s}`).addEventListener("click",()=>{console.log(`type: ${e.type}`),dialog_e.close(r)}),dialog_e.addEventListener("click",e=>{e.target===dialog_e&&dialog_e.close(r)}),dialog_e.addEventListener("close",t=>{e.result=dialog_e.returnValue}),dialog_e.showModal()},DOM_toClipboard=e=>{const t=()=>{e.mark+=" impossible",DOM_dialog(e,!0)};navigator.permissions.query({name:"clipboard-write"}).then(s=>{"granted"!=s.state&&"prompt"!=s.state||navigator.clipboard.writeText(e.content).then(()=>{DOM_dialog(e)},()=>{t()})}).catch(()=>{t()})},mailToClipDialog=()=>{const e={type:"note",header:"Adresse pour me contacter",content:((e,t)=>{const s=e=>String.fromCharCode((e<="Z"?90:122)>=(e=e.charCodeAt(0)+13)?e:e-26);return`${e.replace(/[a-zA-Z]/g,s)}@${t.replace(/[a-zA-Z]/g,s)}`})("nqhcva","purepurheq.neg"),mark:"<p><mark>copie dans le presse-papier</mark></p>"};DOM_toClipboard(e)},confirmDialog=(e,t)=>{DOM_dialog({type:"confirm",content:e,options_a:["Je renonce","Je confirme"],callback_f:t})},statusDialog=()=>{DOM_dialog({type:"status"})},searchTagsDialog=()=>{DOM_dialog({type:"search"})},contextDialog=e=>{const t={type:e};"user_file"===e&&(t.options_a=["Abandonner","Analyser"],t.callback_f=userImgFileToIDB),"user_file_modify"===e&&(t.options_a=["Abandonner","Modifier"],t.callback_f=userGalleryItemUpdate),DOM_dialog(t)};class DragElement{constructor(e,t){this.gapX=0,this.gapY=0,this.offsetX=0,this.offsetY=0,this.atX=0,this.atY=0,this.drag_e=e,this.keep_b=t||!1,this.start()}start(){this.drag_e.onmousedown=(e=>(this.loose=!1,this.gapX=e.clientX-this.offsetX,this.gapY=e.clientY-this.offsetY,this.drag_e.addEventListener("mousemove",this,!1),this.drag_e.addEventListener("mouseup",this,!1),!1))}disable(){this.loose=!0}handleEvent(e){return!this.loose&&("mousemove"===e.type?(this.atX=e.clientX-this.gapX,this.atY=e.clientY-this.gapY,this.offsetX=this.atX,this.offsetY=this.atY,this.drag_e.style.transform=`translate3d(${this.atX}px, ${this.atY}px, 0)`,!1):void("mouseup"===e.type&&(this.keep_b||(this.drag_e.removeEventListener("mousemove",this,!0),this.drag_e.removeEventListener("mouseup",this,!0)),this.loose=!0)))}}const RGB_H=(e,t,s)=>{const r=Math.min(e,t,s),o=Math.max(e,t,s);if(o===r)return 0;const a=o-r,n=o===e?(t-s)/a+(t<s?6:0):o===t?(s-e)/a+2:(e-t)/a+4;return Math.floor(60*n)},RGB_S=(e,t,s)=>{const r=Math.min(e,t,s),o=Math.max(e,t,s),a=o-r;if(!a)return 0;const n=r+o;return n>255?a/(510-o-r):a/n},RGB_L=(e,t,s)=>(Math.min(e,t,s)+Math.max(e,t,s))/510,HSL_RGB=(e,t,s)=>{let r,o,a;if(0===t)r=o=a=s;else{const n=(e,t,s)=>(s<0&&(s+=1),s>1&&(s-=1),s<.1666667?e+6*(t-e)*s:s<.5?t:s<.6666667?e+(t-e)*(.6666667-s)*6:e),i=s<.5?s*(1+t):s+t-s*t,c=2*s-i;r=n(c,i,(e/=360)+.3333334),o=n(c,i,e),a=n(c,i,e-.3333334)}return[r,o,a]},H_toMatrix=e=>{let t,s,r,o=DOM_getRootVar("--M3_FE_MATRIX");return e<0?t=s=r=DOM_getRootVar("--M3_FE_MATRIX_GRAY_VALUE"):(rgb_a=HSL_RGB(e,1,.5),t=rgb_a[0]+.5,s=rgb_a[1]+.5,r=rgb_a[2]+.5),o=o.replace("R",t).replace("G",s).replace("B",r)};class DOM_FeColorMatrix{constructor(e,t,s){this._animateID=t||"ca_animate",this._filter_e=document.getElementById(e),this.createMatrix(s)}toMatrix(e){return{from_s:`${e.r0} 0 0 0 0    0 ${e.g0} 0 0 0    0 0 ${e.b0} 0 0    0 0 0 1 0`,to_s:`${e.r1} 0 0 0 0    0 ${e.g1} 0 0 0    0 0 ${e.b1} 0 0    0 0 0 1 0`}}toBegin(e,t){let s=void 0!==t?`${t}s;`:"";return void 0!==e&&(s+=`${e}.end`),s}toDuration(e){return`${e.d}s`}createAnimate(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg","animate");let r,o;return s.setAttribute("id",`${this._animateID}_${e}`),s.setAttribute("attributeType","XML"),s.setAttribute("attributeName","values"),s.setAttribute("dur",this.toDuration(t)),s.setAttribute("repeatCount",1),({from_s:r,to_s:o}=this.toMatrix(t)),s.setAttribute("from",r),s.setAttribute("to",o),s}createMatrix(e){const t=e.length-1;for(let s=0;s<=t;++s){const r=this.createAnimate(s,e[s]),o=0===s?this.toBegin(`${this._animateID}_${t}`,0):this.toBegin(`${this._animateID}_${s-1}`);r.setAttribute("begin",o),this._filter_e.appendChild(r)}}}class LogScale{constructor(e){this.minpos=e.minpos||0,this.minlval=Math.log(e.minval||1),this.maxlval=Math.log(e.maxval||1e5),this.scale=(this.maxlval-this.minlval)/(e.maxpos-this.minpos)}getPosition(e){return this.minpos+(Math.log(e)-this.minlval)/this.scale}}const AreaActive=e=>document.getElementById(`ca_area_${e}`),AreaSwap=(e,t)=>{AreaActive(e).classList.toggle("ca_area_active"),AreaActive(t).classList.toggle("ca_area_active")},AreaSwitch=e=>{const t=null!==document.querySelector(".ca_area_perspective");document.getElementById("ca_content").classList.toggle("ca_content_perspective");const s=document.getElementsByClassName("ca_area"),r=document.getElementsByClassName("ca_area_selector"),o=r.length;for(let e=0;e<o;++e)s.item(e).classList.toggle("ca_area_perspective"),r.item(e).classList.toggle("ca_selector_perspective");t?document.getElementById(e.replace("select_","")).classList.toggle("ca_area_active"):document.querySelector(".ca_area_active").classList.toggle("ca_area_active")},ScrollLevel=e=>{document.getElementById("ca_grad_down_empty").setAttribute("offset",`${e}%`),document.getElementById("ca_grad_down_fill").setAttribute("offset",`${e}%`),e=100-e,document.getElementById("ca_grad_up_empty").setAttribute("offset",`${e}%`),document.getElementById("ca_grad_up_fill").setAttribute("offset",`${e}%`)},ScrollPosition=e=>{const t=document.body.scrollHeight-window.innerHeight||1;ScrollLevel(Math.floor(e/t*100))},ScrollPage=e=>{const t={left:0,top:window.innerHeight*e,behavior:"smooth"};window.scrollBy(t),ScrollPosition(window.pageYOffset)};window.addEventListener("scroll",e=>{ScrollPosition(window.pageYOffset)});const CA_search={port_o:null,tags:["ORD","PER","ART","WORK","COL","BIB","WEB","LOC","DATE"],titles:["INDÉFINI","NOM DE PERSONNE","NOM D'ARTISTE","ŒUVRE D'ART","COLLECTION","BIBLIOGRAPHIE","TECHNOLOGIE","LOCALISATION","DATE"],need_s:"",tag_n:0,tag_s:""},fromProvider=e=>{const t=e.result;searchOutputEntries(t?t.length?t:"NOT_FOUND":"RESET"),"RETRIEVE"===e.task_s&&(CA_search.need_s=t[0].need_s,CA_search.tag_s=t[0].tag_s,searchUpdateRequest())};(()=>{const e=new SharedWorker(`${SITE_ROOT_URL}static/scripts/search_w.js`);CA_search.port_o=e.port,CA_search.port_o.onmessageerror=(e=>console.log(`CLIENT ERROR: ${e.message}`)),CA_search.port_o.onmessage=(e=>{fromProvider(e.data)}),CA_search.port_o.start(),CA_search.port_o.postMessage({task_s:"INIT",url_s:`${SITE_ROOT_URL}search.ini`}),CA_search.port_o.postMessage({task_s:"RETRIEVE"})})();const searchOutputEntries=e=>{const t=document.getElementById("ca_search_list");for(;t.firstChild;)t.removeChild(t.firstChild);let s,r,o,a,n,i,c,l,_,d;if("string"==typeof e){if("RESET"===e)return;return s=document.getElementById("ca_search_result_entry_void"),o=(r=document.importNode(s.content,!0)).querySelectorAll("dt"),a="NOT_FOUND"===e?"Auncun résultat n'a été trouvé. Essayez avec un autre filtre.":"Le terme fourni pour la recherche est invalide!",o[0].textContent=a,void t.appendChild(r)}s=document.getElementById("ca_search_result_entry");let h=-1;for(entry_o in e)++h,n=(r=document.importNode(s.content,!0)).querySelectorAll("div.ca_urlentry"),e[entry_o].visited&&n[0].classList.toggle("ca_urlentry_mark"),i=r.querySelectorAll("dl"),(l=r.querySelectorAll("a"))[0].setAttribute("href",`${SITE_ROOT_URL}${e[entry_o].path_s}.html`),l[0].setAttribute("data-entry",`${h}`),l[0].setAttribute("onclick","searchVisit( this )"),l[0].textContent=e[entry_o].title_s,(c=r.querySelectorAll("dt"))[0].appendChild(l[0]),i[0].appendChild(c[0]),(_=r.querySelectorAll("dd"))[0].textContent=e[entry_o].date_s+" ",(d=document.createElement("em")).textContent=e[entry_o].author_s,_[0].appendChild(d),i[0].appendChild(_[0]),_[1].textContent=e[entry_o].abstract_s,i[0].appendChild(_[1]),n[0].appendChild(i[0]),t.appendChild(n[0])},searchUpdateRequest=()=>{searchSetMarks(),searchSetNeedForm();const e=CA_search.tags.findIndex(e=>e===CA_search.tag_s);searchSetTagForm(e)},searchSetNeedForm=e=>document.getElementById("ca_form_input_search_needle").value=CA_search.need_s,searchSetTagForm=e=>document.getElementById("ca_form_input_search_tag").innerHTML=CA_search.titles[e],searchSetTag=e=>{CA_search.tag_n=e,searchSetTagForm(e)},searchSubmit=()=>{const e=document.getElementById("ca_form_input_search_needle").value.replace(/[^a-zA_Z\d\s&'\-]/gi,"");if(0===e.length)return searchOutputEntries("BAD_ENTRY");const t=CA_search.tags[CA_search.tag_n];CA_search.port_o.postMessage({task_s:"SEARCH",need_s:e,tag_s:t})},searchVisit=e=>{CA_search.port_o.postMessage({task_s:"VISIT_URL",entry:e.getAttribute("data-entry")});let t=e.parentNode;for(;t&&!t.classList.contains("ca_urlentry");)t=t.parentNode;t.classList.toggle("ca_urlentry_mark")},searchReset=()=>{searchSetMarks(),searchOutputEntries("RESET"),CA_search.need_s="",CA_search.tag_s="",CA_search.port_o.postMessage({task_s:"RESET"})},searchPrevious=()=>CA_search.port_o.postMessage({task_s:"PREVIOUS"}),searchNext=()=>CA_search.port_o.postMessage({task_s:"NEXT"}),searchSetMarks=()=>{const e=CA_search.need_s;document.querySelectorAll(`mark[data-tag="${CA_search.tag_s}"]`).forEach(t=>{t.innerText.indexOf(e)>-1&&t.classList.toggle("ca_searchentry_mark")})};

