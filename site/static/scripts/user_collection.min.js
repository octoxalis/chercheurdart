
const CA_user_collection_o={LAZY_LIMIT:8,itemId_e:null,itemTag_e:null,dialogs_o:{open_s:'<form class="ca_filebox_form ca_layout_centered_block">\n    <label class="ca_inputbox_label_solo ca_inputbox_label_text">',close_s:"</label></form>",itemDelete_s:"Voulez-vous vraiment supprimer cette image de votre galerie?",galleryDelete_s:"Voulez-vous vraiment supprimer la totalitÃ© des images de cette galerie?"}},userCollectionDescriptionToDOM=e=>{let t=0;for(let l in e)t+=e[l].length;const l=document.getElementById("ca_user_collection_description_list"),_=document.getElementById("ca_user_collection_description_template"),i=document.importNode(_.content,!0),s=i.querySelector("dl#ca_user_collection_description_item"),a=i.querySelector("dt.ca_user_gallery_descriptor"),o=i.querySelector("input#ca_user_gallery_descriptor_input");o.setAttribute("id","ca_user_gallery_description_item_input"),a.appendChild(o);const r=i.querySelector("label.ca_inputbox_label_solo");r.setAttribute("for","ca_user_gallery_descriptor_input");let c=Object.keys(e).length>1?"s":"";r.textContent=`${Object.keys(e).length} galerie${c}`,a.appendChild(r),s.appendChild(a);let n=i.querySelector("dd.ca_user_gallery_descriptor");c=t>1?"s":"",n.textContent=`${t} image${c}`,s.appendChild(n),n=i.getElementById("ca_user_collection_add"),s.appendChild(n),l.appendChild(s)},userCollectionDescriptionEvents=()=>{document.getElementById("ca_user_collection_description_list").parentElement.addEventListener("click",e=>{const t=e.target;if("ca_user_gallery_descriptor_label"===t.id){const e=null;return CA_user_o.galleryIdb_i.set("tag_s",e),userGalleryInit(e),void AreaSwap("text","gallery")}("ca_user_collection_add_label"===t.id||t.classList.contains("ca_svg_icon"))&&contextDialog("user_file")})},userGalleryDescriptionToDOM=e=>{const t=document.getElementById("ca_user_gallery_description_list"),l=document.getElementById("ca_user_gallery_description_list_template");let _,i,s,a,o,r,c=-1;for(let n in e){++c;let d,u,g=e[n].length,m=e[n][0].tag_s,y=e[n][0].key_n;({now_s:d,locale_s:u}=dateAsLocale(y)),(i=(_=document.importNode(l.content,!0)).querySelector("dl#ca_user_gallery_description_item")).setAttribute("id",`ca_user_gallery_description_item_${c}`),s=_.querySelector("dt.ca_user_gallery_descriptor"),i.appendChild(s),(o=_.querySelector("input#ca_user_gallery_description_item_input")).setAttribute("id",`ca_user_gallery_description_item_input_${c}`),s.appendChild(o),(r=_.querySelector("label.ca_inputbox_label_solo")).setAttribute("for",`ca_user_gallery_description_item_input_${c}`),r.setAttribute("data-tag",m),r.textContent=`${m}`,s.appendChild(r),a=_.querySelectorAll("dd.ca_user_gallery_descriptor");let p=g>1?"s":"";a[0].textContent=`${g} image${p}`,i.appendChild(a[0]),a[1].textContent=`${u}`,i.appendChild(a[1]),t.appendChild(i)}},userGalleryDescriptionEvents=()=>{document.getElementById("ca_user_gallery_description_list").parentElement.addEventListener("click",e=>{if("LABEL"===e.target.tagName){const t=e.target.getAttribute("data-tag");CA_user_o.galleryIdb_i.set("tag_s",t),userGalleryInit(t),AreaSwap("text","gallery")}})},userGalleryImgToDOM=e=>{const t=document.querySelector(".ca_gallery_imgs_list");let l,_,i,s,a,o,r,c=document.getElementById("ca_user_gallery_description_template"),n=-1;for(let d in e)++n,r=e[d].item_o,(_=(l=document.importNode(c.content,!0)).querySelector("li#ca_user_gallery_list_item")).setAttribute("id",`ca_user_gallery_list_item_${n}`),_.setAttribute("data-key",e[d].key_n),_.setAttribute("data-file",r.file_s),i=l.querySelector("div.ca_list_imgs_frame"),(s=l.querySelector("img.ca_list_imgs_img")).setAttribute("data-src-width",r.width),s.setAttribute("data-src-height",r.height),s.setAttribute("src",r.src_s),s.setAttribute("loading",n>CA_user_collection_o.LAZY_LIMIT?"lazy":"auto"),i.appendChild(s),_.appendChild(i),i=l.querySelector("div#ca_user_gallery_list_item_trigger"),_.appendChild(i),a=l.querySelector("ul.ca_list_imgs_legend"),(o=l.querySelector("li.ca_list_imgs_legend_title")).textContent=r.file_s,a.appendChild(o),(o=l.querySelector("li.ca_list_imgs_legend_author")).textContent=r.id_s,a.appendChild(o),(o=l.querySelector("li.ca_list_imgs_legend_collector")).textContent=r.tag_s,a.appendChild(o),_.appendChild(a),t.appendChild(_)},userGalleryImgEvents=()=>{document.getElementById("ca_gallery_imgs_list").addEventListener("click",e=>{const t=e.target;if("svg"!==t.tagName&&"DIV"!==t.tagName)if("IMG"!==t.tagName){if(t.classList.contains("ca_list_imgs_legend_title")){const e=t.closest("li[data-key]");CA_user_o.galleryIdb_i.set("key_n",parseInt(e.getAttribute("data-key"))).then(()=>window.location=`${SITE_ROOT_URL}user/items/2019-05-08-collection_item.html`)}else if(t.classList.contains("ca_list_imgs_legend_author")||t.classList.contains("ca_list_imgs_legend_collector")){const e=t.closest("li[data-key]").getAttribute("data-key"),l=t.closest(".ca_list_imgs_legend");CA_user_collection_o.itemId_e=l.getElementsByClassName("ca_list_imgs_legend_author")[0];const _=document.getElementById("ca_form_input_is_user_file_update_id");CA_user_collection_o.itemTag_e=l.getElementsByClassName("ca_list_imgs_legend_collector")[0];const i=document.getElementById("ca_form_input_is_user_file_update_tag");return _.setAttribute("data-key",e),_.setAttribute("placeholder",CA_user_collection_o.itemId_e.innerHTML),_.value=CA_user_collection_o.itemId_e.innerHTML,i.setAttribute("data-key",e),i.setAttribute("placeholder",CA_user_collection_o.itemTag_e.innerHTML),i.value=CA_user_collection_o.itemTag_e.innerHTML,void contextDialog("user_file_modify",userGalleryItemUpdate)}}else{const e=t.closest("li[data-file]");e&&e.classList.toggle("ca_list_imgs_islarge")}else{const e=t.closest("li[data-key]");userGalleryitemDelete(e.getAttribute("data-key"))}})},usergalleryDelete=e=>{const t=`${CA_user_collection_o.dialogs_o.open_s}${CA_user_collection_o.dialogs_o.galleryDelete_s}${CA_user_collection_o.dialogs_o.close_s}`;confirmDialog(t,t=>{t&&t.includes("dialog_option_0")&&CA_user_o.collectionIdb_i.deleteAll(t=>!e||e===t.tag_s).then(()=>{}).catch(t=>{console.log(`ERROR IDB: delete ${e} failed`)})})},userGalleryItemUpdate=e=>{if(!e||!e.includes("dialog_option_0"))return;const t=document.getElementById("ca_form_input_is_user_file_update_id"),l=parseInt(t.getAttribute("data-key")),_=t.value,i=document.getElementById("ca_form_input_is_user_file_update_tag"),s=i.value;_!==t.getAttribute("placeholder")&&(CA_user_o.collectionIdb_i.update(l,"id_s",_),CA_user_collection_o.itemId_e.innerHTML=_),s!==i.getAttribute("placeholder")&&(CA_user_o.collectionIdb_i.update(l,"tag_s",s),CA_user_collection_o.itemTag_e.innerHTML=s)},userGalleryitemDelete=e=>{const t=`${CA_user_collection_o.dialogs_o.open_s}${CA_user_collection_o.dialogs_o.itemDelete_s}${CA_user_collection_o.dialogs_o.close_s}`;confirmDialog(t,t=>{t&&t.includes("dialog_option_0")&&CA_user_o.collectionIdb_i.delete(parseInt(e)).then(()=>{const t=document.querySelector(`li[data-key="${e}"]`);t&&document.getElementById("ca_gallery_imgs_list").removeChild(t)}).catch(t=>{console.log(`ERROR IDB: delete ${e} failed`)})})},userCollectionGetGalleries=()=>{CA_user_collection_o.galleries_a=[],CA_user_o.collectionIdb_i.walk((e,t)=>{const{file_s:l,tag_s:_}=t;CA_user_collection_o.galleries_a[_]||(CA_user_collection_o.galleries_a[_]=[]),CA_user_collection_o.galleries_a[_].push({key_n:e,file_s:l,tag_s:_})}).then(()=>{userCollectionDescriptionToDOM(CA_user_collection_o.galleries_a),document.getElementById("ca_user_collection_description_list").parentElement.addEventListener("click",e=>{const t=e.target;if("ca_user_gallery_descriptor_label"===t.id){const e=null;return CA_user_o.galleryIdb_i.set("tag_s",e),userGalleryInit(e),void AreaSwap("text","gallery")}("ca_user_collection_add_label"===t.id||t.classList.contains("ca_svg_icon"))&&contextDialog("user_file")}),userGalleryDescriptionToDOM(CA_user_collection_o.galleries_a),document.getElementById("ca_user_gallery_description_list").parentElement.addEventListener("click",e=>{if("LABEL"===e.target.tagName){const t=e.target.getAttribute("data-tag");CA_user_o.galleryIdb_i.set("tag_s",t),userGalleryInit(t),AreaSwap("text","gallery")}}),CA_user_o.galleryIdb_i.get("tag_s").then(e=>userGalleryInit(e))})},userGalleryGetItems=e=>{let t=[];CA_user_o.collectionIdb_i.walk((l,_)=>{e&&e!==_.tag_s||t.push({key_n:l,item_o:_})}).then(()=>userGalleryImgToDOM(t))},userGalleryInit=e=>{DOM_resetNode("ca_gallery_imgs_list"),userGalleryGetItems(e),document.getElementById("ca_gallery_imgs_list").addEventListener("click",e=>{const t=e.target;if("svg"!==t.tagName&&"DIV"!==t.tagName)if("IMG"!==t.tagName){if(t.classList.contains("ca_list_imgs_legend_title")){const e=t.closest("li[data-key]");CA_user_o.galleryIdb_i.set("key_n",parseInt(e.getAttribute("data-key"))).then(()=>window.location=`${SITE_ROOT_URL}user/items/2019-05-08-collection_item.html`)}else if(t.classList.contains("ca_list_imgs_legend_author")||t.classList.contains("ca_list_imgs_legend_collector")){const e=t.closest("li[data-key]").getAttribute("data-key"),l=t.closest(".ca_list_imgs_legend");CA_user_collection_o.itemId_e=l.getElementsByClassName("ca_list_imgs_legend_author")[0];const _=document.getElementById("ca_form_input_is_user_file_update_id");CA_user_collection_o.itemTag_e=l.getElementsByClassName("ca_list_imgs_legend_collector")[0];const i=document.getElementById("ca_form_input_is_user_file_update_tag");return _.setAttribute("data-key",e),_.setAttribute("placeholder",CA_user_collection_o.itemId_e.innerHTML),_.value=CA_user_collection_o.itemId_e.innerHTML,i.setAttribute("data-key",e),i.setAttribute("placeholder",CA_user_collection_o.itemTag_e.innerHTML),i.value=CA_user_collection_o.itemTag_e.innerHTML,void contextDialog("user_file_modify",userGalleryItemUpdate)}}else{const e=t.closest("li[data-file]");e&&e.classList.toggle("ca_list_imgs_islarge")}else{const e=t.closest("li[data-key]");userGalleryitemDelete(e.getAttribute("data-key"))}})};window.onload=(()=>(CA_user_collection_o.galleries_a=[],void CA_user_o.collectionIdb_i.walk((e,t)=>{const{file_s:l,tag_s:_}=t;CA_user_collection_o.galleries_a[_]||(CA_user_collection_o.galleries_a[_]=[]),CA_user_collection_o.galleries_a[_].push({key_n:e,file_s:l,tag_s:_})}).then(()=>{userCollectionDescriptionToDOM(CA_user_collection_o.galleries_a),document.getElementById("ca_user_collection_description_list").parentElement.addEventListener("click",e=>{const t=e.target;if("ca_user_gallery_descriptor_label"===t.id){const e=null;return CA_user_o.galleryIdb_i.set("tag_s",e),userGalleryInit(e),void AreaSwap("text","gallery")}("ca_user_collection_add_label"===t.id||t.classList.contains("ca_svg_icon"))&&contextDialog("user_file")}),userGalleryDescriptionToDOM(CA_user_collection_o.galleries_a),document.getElementById("ca_user_gallery_description_list").parentElement.addEventListener("click",e=>{if("LABEL"===e.target.tagName){const t=e.target.getAttribute("data-tag");CA_user_o.galleryIdb_i.set("tag_s",t),userGalleryInit(t),AreaSwap("text","gallery")}}),CA_user_o.galleryIdb_i.get("tag_s").then(e=>userGalleryInit(e))})));

